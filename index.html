<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <!-- Список рендерится -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          oninput="getName();"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          oninput="getText()"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>

      <!-- <div class="delete-comment">
        <button class="delete-comment-button">Удалить комментарий</button>
      </div> -->
    </div>
  </body>

  <script>
    const buttonAddComment = document.querySelector(".add-form-button");
    const userName = document.querySelector(".add-form-name");
    const userСomment = document.querySelector(".add-form-text");
    const listComments = document.querySelector(".comments");
    buttonAddComment.disabled = true;
    let comments = [];
    let isLoading = false;

    //Получаем данные с сервера
    function fetchGetData() {
      return fetch(
        "https://webdev-hw-api.vercel.app/api/v1/zainullina/comments",
        {
          method: "GET",
        }
      )
        .then((response) => {
          if (response.status === 500) {
            throw new Error("Сервер сломался, попробуй позже");
          }
          return response.json();
        })
        .then((responseData) => {
          const appComments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date: new Date(comment.date),
              text: comment.text,
              likes: comment.likes,
              isLiked: false,
              isLikeLoading: false,
            };
          });
          comments = appComments;
          renderComments();
        })
        .catch((error) => {
          if (error.message === "Сервер сломался, попробуй позже") {
            alert("Сервер сломался, попробуй позже");
          } else {
            alert("Кажется, у вас сломался интернет, попробуйте позже");
          }
        });
    }

    listComments.textContent =
      "Пожалуйста подождите, комментарии загружаются...";
    fetchGetData();

    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }
    // Функция для проставления лайков
    const likeComment = () => {
      const likesButton = document.querySelectorAll(".like-button");
      const counter = document.querySelectorAll(".likes-counter");

      for (const item of likesButton) {
        item.addEventListener("click", (event) => {
          event.stopPropagation();
          const index = item.dataset.index;

          comments[index].isLikeLoading = true;
          renderComments();
          delay(2000).then(() => {
            comments[index].likes = comments[index].isLiked
              ? comments[index].likes - 1
              : comments[index].likes + 1;
            comments[index].isLiked = !comments[index].isLiked;
            comments[index].isLikeLoading = false;
            renderComments();
          });
        });
      }
    };

    //Функция изменения комментария
    // const editComment = () => {
    //   const editButtons = document.querySelectorAll(".edit-button");
    //   const commentText = document.querySelectorAll(".comment-text");
    //   for (const editButton of editButtons) {
    //     let isEdit = false;

    //     editButton.addEventListener("click", (event) => {
    //       event.stopPropagation();
    //       const index = editButton.dataset.index;

    //       if (!isEdit) {
    //         commentText[index].innerHTML = `<textarea
    //       type="textarea"
    //       id="edit-text"
    //       rows="4" style="width:500px"
    //     >${commentText[index].innerText}</textarea>`;
    //         editButton.innerText = "Сохранить";
    //       } else {
    //         const newText = document.getElementById("edit-text");
    //         comments[index].text = newText.value;
    //         renderComments();
    //       }

    //       isEdit = !isEdit;
    //     });
    //   }
    // };

    //Ответ на комментарий
    // const replyToComment = () => {
    //   const commentElements = document.querySelectorAll(".comment");
    //   const textareaText = document.querySelector(".add-form-text");

    //   for (const commentElement of commentElements) {
    //     commentElement.addEventListener("click", () => {
    //       const index = commentElement.dataset.index;
    //       textareaText.value = `QUOTE_BEGIN ${comments[index].name}:\n${comments[index].text} QUOTE_END`;
    //     });
    //   }
    // };

    function formatDate(time) {
      if (time < 10) {
        time = "0" + time;
      }
      return time;
    }

    function getData(date) {
      return `${date.getDate()}.${formatDate(date.getMonth() + 1)}.${String(
        date.getFullYear()
      ).slice(2)} ${formatDate(date.getHours())}:${formatDate(
        date.getMinutes()
      )}`;
    }

    // Рендеринг комментраиев
    const renderComments = () => {
      const commentsHTML = comments
        .map((item, index) => {
          return `<li class="comment">
          <div class="comment-header">
            <div>${item.name}</div>
            <div>${getData(item.date)}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${item.text
                .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
                .replaceAll("QUOTE_END", "</div>")}
            </div>
          </div>
          <div class="comment-footer">
            <button class="edit-button">Редактировать</button>
            <div class="likes">
              <span class="likes-counter">${item.likes}</span>
              <button data-index='${index}' class="like-button ${
            item.isLiked ? "-active-like" : ""
          } ${item.isLikeLoading ? "-loading-like" : ""}"></button>
            </div>
          </div>
        </li>`;
        })
        .join("");

      listComments.innerHTML = commentsHTML;
      likeComment();
      // editComment();
      // replyToComment();
    };

    //Рендеринг формы
    const renderForm = (isLoading, insertedName, insertedText) => {
      const formWindow = document.querySelector(".add-form");
      if (isLoading) {
        formWindow.innerHTML = `Комментарий добавляется...`;
      } else {
        formWindow.innerHTML = ` <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          oninput="getName();"
          ${insertedName ? `value = ${insertedName}` : ""}
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          oninput="getText();"
        >${insertedText}</textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>`;
      }
    };

    const getName = () => userName.value;
    const getText = () => userСomment.value;

    // Добавление новых комментариев
    function addComment() {
      userName.classList.remove("error");

      if (userName.value == "") {
        userName.classList.add("error");
        return;
      }

      userСomment.classList.remove("error");

      if (userСomment.value == "") {
        userСomment.classList.add("error");
        return;
      }
      isLoading = true;
      renderForm(isLoading);
      console.log(userName.value);

      fetch("https://webdev-hw-api.vercel.app/api/v1/zainullina/comments", {
        method: "POST",
        body: JSON.stringify({
          text: userСomment.value
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
          name: userName.value
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
        }),
        // forceError: true,
      })
        .then((response) => {
          if (response.status === 400) {
            throw new Error(
              "Имя и комментарий должны быть не короче 3 символов"
            );
          }
          if (response.status === 500) {
            throw new Error("Сервер сломался, попробуй позже");
          }
          return response.json();
        })
        .then((responseData) => {
          return fetchGetData();
        })
        .then(() => {
          isLoading = false;
          renderForm(isLoading, "", "");
          userСomment.value = "";
          userName.value = "";
        })
        .catch((error) => {
          isLoading = false;
          const insertedName = getName();
          const insertedText = getText();

          renderForm(isLoading, insertedName, insertedText);
          if (
            error.message ===
            "Имя и комментарий должны быть не короче 3 символов"
          ) {
            alert("Имя и комментарий должны быть не короче 3 символов");
          } else if (error.message === "Сервер сломался, попробуй позже") {
            alert("Сервер сломался, попробуй позже");
          } else {
            alert("Кажется, у вас сломался интернет, попробуйте позже");
          }
        });

      buttonAddComment.disabled = true;
    }

    //Включение некликабельности кнопки при отсутствии имени
    userName.addEventListener("input", () => {
      buttonAddComment.disabled = false;
    });

    // Обработчик события добавление комментария
    buttonAddComment.addEventListener("click", () => {
      console.log("Прослушать кнопку добавления");
      addComment();
    });

    // Обработчик события добавление комментария по нажатию enter
    userСomment.addEventListener("keyup", (event) => {
      if (event.code == "Enter") {
        addComment();
      }
    });

    //Удаление последнего комментария
    // const deleteButton = document.querySelector(".delete-comment-button");

    // deleteButton.addEventListener("click", () => {
    //   comments.pop();
    //   renderComments();
    // });
  </script>
</html>
