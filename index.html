<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <!-- Список рендерится -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>

      <div class="delete-comment">
        <button class="delete-comment-button">Удалить комментарий</button>
      </div>
    </div>
  </body>

  <script>
    const buttonAddComment = document.querySelector(".add-form-button");
    const userName = document.querySelector(".add-form-name");
    const userСomment = document.querySelector(".add-form-text");
    const listComments = document.querySelector(".comments");
    buttonAddComment.disabled = true;

    const comments = [
      {
        name: "Глеб Фокин",
        date: "12.02.22 12:18",
        text: "Это будет первый комментарий на этой странице",
        likes: 3,
        isliked: false,
      },
      {
        name: "Варвара Н.",
        date: "13.02.22 19:22",
        text: "Мне нравится как оформлена эта страница! ❤",
        likes: 75,
        isliked: false,
      },
    ];

    // Функция для проставления лайков
    const likeComment = () => {
      const likesButton = document.querySelectorAll(".like-button");
      const counter = document.querySelectorAll(".likes-counter");

      for (const item of likesButton) {
        item.addEventListener("click", (event) => {
          event.stopPropagation();
          const index = item.dataset.index;

          if (item.classList.contains("-active-like")) {
            comments[index].likes -= 1;
            item.classList.remove("-active-like");
            counter[index].innerText = comments[index].likes;
            comments[index].isliked = false;
          } else {
            comments[index].likes += 1;
            item.classList.add("-active-like");
            counter[index].innerText = comments[index].likes;
            comments[index].isliked = true;
          }
        });
      }
    };

    //Функция изменения комментария
    const editComment = () => {
      const editButtons = document.querySelectorAll(".edit-button");
      const commentText = document.querySelectorAll(".comment-text");
      for (const editButton of editButtons) {
        let isEdit = false;

        editButton.addEventListener("click", (event) => {
          event.stopPropagation();
          const index = editButton.dataset.index;

          if (!isEdit) {
            commentText[index].innerHTML = `<textarea
          type="textarea"
          id="edit-text"
          rows="4" style="width:500px"
        >${commentText[index].innerText}</textarea>`;
            editButton.innerText = "Сохранить";
          } else {
            const newText = document.getElementById("edit-text");
            comments[index].text = newText.value;
            renderComments();
          }

          isEdit = !isEdit;
        });
      }
    };

    //Ответ на комментарий
    const replyToComment = () => {
      const commentElements = document.querySelectorAll(".comment");
      const textareaText = document.querySelector(".add-form-text");

      for (const commentElement of commentElements) {
        commentElement.addEventListener("click", () => {
          const index = commentElement.dataset.index;
          textareaText.value = `QUOTE_BEGIN ${comments[index].name}:\n${comments[index].text} QUOTE_END`;
        });
      }
    };

    // Рендеринг комментраиев
    const renderComments = () => {
      const commentsHTML = comments
        .map((item, index) => {
          return `<li class="comment" data-index=${index}>
          <div class="comment-header">
            <div>${item.name}</div>
            <div>${item.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${item.text
                .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
                .replaceAll("QUOTE_END", "</div>")}
            </div>
          </div>
          <div class="comment-footer">
            <button data-index='${index}' class="edit-button">Редактировать</button>
            <div class="likes">
              <span class="likes-counter">${item.likes}</span>
              <button data-index='${index}' class="like-button ${
            item.isliked ? "-active-like" : ""
          }"></button>
            </div>
          </div>
        </li>`;
        })
        .join("");

      listComments.innerHTML = commentsHTML;
      likeComment();
      editComment();
      replyToComment();
    };

    renderComments();

    function formatDate(time) {
      if (time < 10) {
        time = "0" + time;
      }
      return time;
    }
    // Добавление новых комментариев
    function addComment() {
      userName.classList.remove("error");

      if (userName.value == "") {
        userName.classList.add("error");
        return;
      }

      userСomment.classList.remove("error");

      if (userСomment.value == "") {
        userСomment.classList.add("error");
        return;
      }

      const dateNow = new Date();
      const oldList = listComments.innerHTML;

      comments.push({
        name: userName.value
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;"),
        date: `${dateNow.getDate()}.${formatDate(dateNow.getMonth())}.${String(
          dateNow.getFullYear()
        ).slice(2)} ${formatDate(dateNow.getHours())}:${formatDate(
          dateNow.getMinutes()
        )}`,
        text: userСomment.value
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;"),
        likes: 0,
      });

      userСomment.value = "";
      userName.value = "";
      buttonAddComment.disabled = true;

      renderComments();
    }

    //Включение некликабельности кнопки при отсутствии имени
    userName.addEventListener("input", () => {
      buttonAddComment.disabled = false;
    });

    // Обработчик события добавление комментария
    buttonAddComment.addEventListener("click", () => {
      addComment();
    });

    // Обработчик события добавление комментария по нажатию enter
    userСomment.addEventListener("keyup", (event) => {
      if (event.code == "Enter") {
        addComment();
      }
    });

    //Удаление последнего комментария
    const deleteButton = document.querySelector(".delete-comment-button");

    deleteButton.addEventListener("click", () => {
      comments.pop();
      renderComments();
    });
  </script>
</html>
